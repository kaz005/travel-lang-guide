{% extends "base.html" %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="my-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ãƒ›ãƒ¼ãƒ </a></li>
            <li class="breadcrumb-item active">ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>è¦³å…‰ã‚¹ãƒãƒƒãƒˆç®¡ç†</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="fas fa-plus"></i> æ–°è¦ã‚¹ãƒãƒƒãƒˆè¿½åŠ 
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”»åƒ</th>
                    <th>åç§°</th>
                    <th>èª¬æ˜</th>
                    <th>ä½ç½®æƒ…å ±</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for spot in spots %}
                <tr>
                    <td>{{ spot.id }}</td>
                    <td>
                        {% if spot.images and spot.images[0].url %}
                        <img src="{{ spot.images[0].url }}" alt="{{ spot.name.ja }}" 
                             style="width: 160px; height: 120px; object-fit: cover;">
                        {% endif %}
                    </td>
                    <td>
                        <div>ğŸ‡¯ğŸ‡µ {{ spot.name.ja }}</div>
                        <div>ğŸ‡ºğŸ‡¸ {{ spot.name.en }}</div>
                        <div>ğŸ‡¨ğŸ‡³ {{ spot.name.zh }}</div>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 300px;">
                            <div>ğŸ‡¯ğŸ‡µ {{ spot.description.ja }}</div>
                            <div>ğŸ‡ºğŸ‡¸ {{ spot.description.en }}</div>
                            <div>ğŸ‡¨ğŸ‡³ {{ spot.description.zh }}</div>
                        </div>
                    </td>
                    <td>
                        <div>Lat: {{ spot.coordinates.lat }}</div>
                        <div>Lng: {{ spot.coordinates.lng }}</div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info mb-1 edit-button" 
                                data-spot='{{ spot|tojson }}'>
                            <i class="fas fa-edit"></i> ç·¨é›†
                        </button>
                        <form action="/admin/spots/{{ spot.id }}/delete" 
                              method="POST" 
                              class="d-inline"
                              onsubmit="return confirm('ã“ã®ã‚¹ãƒãƒƒãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
                            <button type="submit" class="btn btn-sm btn-danger mb-1">
                                <i class="fas fa-trash"></i> å‰Šé™¤
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°è¦ã‚¹ãƒãƒƒãƒˆä½œæˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm" action="/admin/spots/create" method="POST">
                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div class="mb-3">
                        <label class="form-label">åç§°</label>
                        <div class="mb-2">
                            <span>ğŸ‡¯ğŸ‡µ</span>
                            <input type="text" class="form-control" name="name_ja" required>
                        </div>
                        <div class="mb-2">
                            <span>ğŸ‡ºğŸ‡¸</span>
                            <input type="text" class="form-control" name="name_en" required>
                        </div>
                        <div>
                            <span>ğŸ‡¨ğŸ‡³</span>
                            <input type="text" class="form-control" name="name_zh" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">èª¬æ˜</label>
                        <div class="mb-2">
                            <span>ğŸ‡¯ğŸ‡µ</span>
                            <textarea class="form-control" name="desc_ja" rows="3" required></textarea>
                        </div>
                        <div class="mb-2">
                            <span>ğŸ‡ºğŸ‡¸</span>
                            <textarea class="form-control" name="desc_en" rows="3" required></textarea>
                        </div>
                        <div>
                            <span>ğŸ‡¨ğŸ‡³</span>
                            <textarea class="form-control" name="desc_zh" rows="3" required></textarea>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ä½ç½®æƒ…å ±</label>
                        <div class="row">
                            <div class="col">
                                <input type="number" class="form-control" name="lat" step="any" placeholder="ç·¯åº¦" required>
                            </div>
                            <div class="col">
                                <input type="number" class="form-control" name="lng" step="any" placeholder="çµŒåº¦" required>
                            </div>
                        </div>
                    </div>

                    <!-- ç”»åƒå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <div class="mb-3">
                        <label class="form-label">ç”»åƒ</label>
                        <div id="createImageInputs">
                            <div class="image-input mb-3">
                                <div class="mb-2">
                                    <select class="form-select mb-2" name="image_types[]">
                                        <option value="external">å¤–éƒ¨URL</option>
                                        <option value="local">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«</option>
                                    </select>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="image_urls[]" placeholder="ç”»åƒURL ã¾ãŸã¯ /static/images/ãƒ•ã‚¡ã‚¤ãƒ«å (ä¾‹: spot1.jpg)">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeImageInput(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">ğŸ‡¯ğŸ‡µ</span>
                                        <input type="text" class="form-control" name="image_captions_ja[]" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æœ¬èªï¼‰">
                                    </div>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">ğŸ‡ºğŸ‡¸</span>
                                        <input type="text" class="form-control" name="image_captions_en[]" placeholder="Caption (English)">
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text">ğŸ‡¨ğŸ‡³</span>
                                        <input type="text" class="form-control" name="image_captions_zh[]" placeholder="æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰">
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">èª¬æ˜æ–‡</label>
                                    <div class="mb-2">
                                        <span>ğŸ‡¯ğŸ‡µ</span>
                                        <textarea class="form-control" name="image_descriptions_ja[]" rows="3" placeholder="å†™çœŸã®èª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰"></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <span>ğŸ‡ºğŸ‡¸</span>
                                        <textarea class="form-control" name="image_descriptions_en[]" rows="3" placeholder="Photo description (English)"></textarea>
                                    </div>
                                    <div>
                                        <span>ğŸ‡¨ğŸ‡³</span>
                                        <textarea class="form-control" name="image_descriptions_zh[]" rows="3" placeholder="ç…§ç‰‡æè¿°ï¼ˆä¸­æ–‡ï¼‰"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="addImageInput('create')">
                            <i class="fas fa-plus"></i> ç”»åƒã‚’è¿½åŠ 
                        </button>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editSpotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ã‚¹ãƒãƒƒãƒˆç·¨é›†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">åç§°</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">ğŸ‡¯ğŸ‡µ</span>
                            <input type="text" class="form-control" name="name_ja" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">ğŸ‡ºğŸ‡¸</span>
                            <input type="text" class="form-control" name="name_en" required>
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">ğŸ‡¨ğŸ‡³</span>
                            <input type="text" class="form-control" name="name_zh" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">èª¬æ˜</label>
                        <div class="mb-2">
                            <span>ğŸ‡¯ğŸ‡µ</span>
                            <textarea class="form-control" name="desc_ja" rows="3" required></textarea>
                        </div>
                        <div class="mb-2">
                            <span>ğŸ‡ºğŸ‡¸</span>
                            <textarea class="form-control" name="desc_en" rows="3" required></textarea>
                        </div>
                        <div>
                            <span>ğŸ‡¨ğŸ‡³</span>
                            <textarea class="form-control" name="desc_zh" rows="3" required></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">ç·¯åº¦</label>
                            <input type="number" class="form-control" name="lat" step="any" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">çµŒåº¦</label>
                            <input type="number" class="form-control" name="lng" step="any" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç”»åƒ</label>
                        <div id="editImageInputs">
                            <!-- æ—¢å­˜ã®ç”»åƒå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary" onclick="addImageInput('edit')">
                            <i class="fas fa-plus"></i> ç”»åƒã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function addImageInput(type) {
    const template = `
        <div class="image-input mb-3">
            <div class="mb-2">
                <select class="form-select mb-2" name="image_types[]">
                    <option value="external">å¤–éƒ¨URL</option>
                    <option value="local">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«</option>
                </select>
                <div class="input-group">
                    <input type="text" class="form-control" name="image_urls[]" placeholder="ç”»åƒURL ã¾ãŸã¯ /static/images/ãƒ•ã‚¡ã‚¤ãƒ«å (ä¾‹: spot1.jpg)">
                    <button type="button" class="btn btn-outline-danger" onclick="removeImageInput(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="mb-2">
                <label class="form-label">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
                <div class="input-group mb-2">
                    <span class="input-group-text">ğŸ‡¯ğŸ‡µ</span>
                    <input type="text" class="form-control" name="image_captions_ja[]" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æœ¬èªï¼‰">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">ğŸ‡ºğŸ‡¸</span>
                    <input type="text" class="form-control" name="image_captions_en[]" placeholder="Caption (English)">
                </div>
                <div class="input-group">
                    <span class="input-group-text">ğŸ‡¨ğŸ‡³</span>
                    <input type="text" class="form-control" name="image_captions_zh[]" placeholder="æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰">
                </div>
            </div>
            <div>
                <label class="form-label">èª¬æ˜æ–‡</label>
                <div class="mb-2">
                    <span>ğŸ‡¯ğŸ‡µ</span>
                    <textarea class="form-control" name="image_descriptions_ja[]" rows="3" placeholder="å†™çœŸã®èª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰"></textarea>
                </div>
                <div class="mb-2">
                    <span>ğŸ‡ºï¿½ï¿½ï¿½ï¿½</span>
                    <textarea class="form-control" name="image_descriptions_en[]" rows="3" placeholder="Photo description (English)"></textarea>
                </div>
                <div>
                    <span>ğŸ‡¨ğŸ‡³</span>
                    <textarea class="form-control" name="image_descriptions_zh[]" rows="3" placeholder="ç…§ç‰‡æè¿°ï¼ˆä¸­æ–‡ï¼‰"></textarea>
                </div>
            </div>
        </div>
    `;
    document.getElementById(type + 'ImageInputs').insertAdjacentHTML('beforeend', template);
}

function removeImageInput(button) {
    button.closest('.image-input').remove();
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setupEditModal(spotData) {
    const form = document.getElementById('editForm');
    form.action = `/admin/spots/${spotData.id}/update`;

    // åŸºæœ¬æƒ…å ±ã‚’è¨­å®š
    form.querySelector('[name="name_ja"]').value = spotData.name.ja;
    form.querySelector('[name="name_en"]').value = spotData.name.en;
    form.querySelector('[name="name_zh"]').value = spotData.name.zh;
    form.querySelector('[name="desc_ja"]').value = spotData.description.ja;
    form.querySelector('[name="desc_en"]').value = spotData.description.en;
    form.querySelector('[name="desc_zh"]').value = spotData.description.zh;
    form.querySelector('[name="lat"]').value = spotData.coordinates.lat;
    form.querySelector('[name="lng"]').value = spotData.coordinates.lng;

    // ç”»åƒå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    const imageInputs = document.getElementById('editImageInputs');
    imageInputs.innerHTML = '';

    // æ—¢å­˜ã®ç”»åƒæƒ…å ±ã‚’è¨­å®š
    if (spotData.images && spotData.images.length > 0) {
        spotData.images.forEach(image => {
            const imageInput = document.createElement('div');
            imageInput.className = 'image-input mb-3';
            imageInput.innerHTML = `
                <div class="mb-2">
                    <select class="form-select mb-2" name="image_types[]">
                        <option value="external" ${image.type === 'external' ? 'selected' : ''}>å¤–éƒ¨URL</option>
                        <option value="local" ${image.type === 'local' ? 'selected' : ''}>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«</option>
                    </select>
                    <div class="input-group">
                        <input type="text" class="form-control" name="image_urls[]" value="${image.url}" placeholder="ç”»åƒURL">
                        <button type="button" class="btn btn-outline-danger" onclick="removeImageInput(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text">ğŸ‡¯ğŸ‡µ</span>
                        <input type="text" class="form-control" name="image_captions_ja[]" value="${image.caption.ja}" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ—¥æœ¬èªï¼‰">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">ğŸ‡ºğŸ‡¸</span>
                        <input type="text" class="form-control" name="image_captions_en[]" value="${image.caption.en}" placeholder="Caption (English)">
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">ğŸ‡¨ğŸ‡³</span>
                        <input type="text" class="form-control" name="image_captions_zh[]" value="${image.caption.zh}" placeholder="æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰">
                    </div>
                </div>
                <div>
                    <label class="form-label">èª¬æ˜æ–‡</label>
                    <div class="mb-2">
                        <span>ğŸ‡¯ğŸ‡µ</span>
                        <textarea class="form-control" name="image_descriptions_ja[]" rows="3" placeholder="å†™çœŸã®èª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰">${image.description ? image.description.ja : ''}</textarea>
                    </div>
                    <div class="mb-2">
                        <span>ğŸ‡ºğŸ‡¸</span>
                        <textarea class="form-control" name="image_descriptions_en[]" rows="3" placeholder="Photo description (English)">${image.description ? image.description.en : ''}</textarea>
                    </div>
                    <div>
                        <span>ğŸ‡¨ğŸ‡³</span>
                        <textarea class="form-control" name="image_descriptions_zh[]" rows="3" placeholder="ç…§ç‰‡æè¿°ï¼ˆä¸­æ–‡ï¼‰">${image.description ? image.description.zh : ''}</textarea>
                    </div>
                </div>
            `;
            imageInputs.appendChild(imageInput);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.edit-button').forEach(function(button) {
        button.addEventListener('click', function() {
            const spot = JSON.parse(this.dataset.spot);
            setupEditModal(spot);
            const modal = document.getElementById('editSpotModal');
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        });
    });
});
</script>
{% endblock %}
